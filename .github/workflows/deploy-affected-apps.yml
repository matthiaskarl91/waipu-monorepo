name: Nx Affected Versioned Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  build-affected:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # so Nx can compare base/head

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # Nx 19+ / 22: use `nx show projects --affected` instead of `print-affected`
      - name: Get affected projects
        id: affected
        run: |
          # Decide base/head depending on event
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE="origin/${{ github.base_ref }}"
            HEAD="HEAD"
          else
          # push to a branch: compare with previous commit on that branch
            BASE="HEAD~1"
            HEAD="HEAD"
          fi

          echo "Using base=$BASE head=$HEAD"

          # Ask Nx which projects are affected
          AFFECTED=$(npx nx show projects --affected --target=build --base="$BASE" --head="$HEAD" || echo "")
          echo "Affected projects: $AFFECTED"

          # Only write a well-formed key=value line to GITHUB_OUTPUT
          echo "apps=$AFFECTED" >> "$GITHUB_OUTPUT"

      # Build affected projects only
      - name: Build affected projects
        run: npx nx affected -t build --parallel=3

      # Rearrange dist into versioned CDN layout: cdn/<app>/<version>/*
      - name: Prepare versioned CDN folder
        run: |
          AFFECTED="${{ steps.affected.outputs.apps }}"
          echo "Using affected projects: $AFFECTED"

          mkdir -p cdn

          # apps we want to publish to the "CDN"
          for APP in funnel csc portal; do
            if echo "$AFFECTED" | grep -qw "$APP"; then
              echo "Processing app: $APP"

              # read version from apps/<app>/package.json
              VERSION=$(node -p "require('./apps/${APP}/package.json').version || '0.0.0'")
              echo "Version for ${APP}: ${VERSION}"

              SRC="dist/apps/${APP}"
              DEST="cdn/${APP}/${VERSION}"

              if [ ! -d "$SRC" ]; then
                echo "Warning: build output not found for ${APP} at ${SRC}, skipping."
                continue
              fi

              mkdir -p "$DEST"
              cp -R "${SRC}/." "$DEST/"
            else
              echo "App ${APP} not affected, skipping."
            fi
          done

          echo "CDN layout:"
          find cdn -maxdepth 3 -type d -print || true

      - name: Upload CDN artifact
        uses: actions/upload-artifact@v4
        with:
          name: cdn-builds
          path: cdn

